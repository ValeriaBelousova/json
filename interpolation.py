# RESULT VERSION
import os
import io
import json
import requests
import datetime
from osgeo import gdal
from osgeo import ogr
from osgeo import osr
import pandas as pd
import geopandas

out_folder = r"W:\Big_Project\__MAPS\!Current\_06_June_21\VB\atmo"

def downloadWeatherData(coord_list):
    weatherJSON = {'lat':[],
                   'lon':[],
                   'date':[],
                   'temp':[],
                   'feels_like':[],
                   'pressure':[],
                   'pressure_mm':[],
                   'wind_speed':[],
                   'osadki':[],
                   'humidity':[]}
    lat_list = []
    lon_list = []
    date_list = []
    temp_list = []
    feels_like_list = []
    pressure_list = []
    pressure_mm_list = []
    wind_speed_list = []
    osadki_list = []
    humidity_list = []
    
    for coord in coord_list:
        lat = coord[1]
        lon = coord[0]
        url_onecall = 'https://api.openweathermap.org/data/2.5/onecall'
        url_param = '?lat=%s&lon=%s&lang=ru&exclude=daily&units=metric'
        url_key = '&appid=6019826c0dc4c2dcb0c3c4a70dcde02c'
        url = 'https://api.openweathermap.org/data/2.5/onecall?lat=%s&lon=%s&lang=ru&exclude=daily&units=metric&appid=6019826c0dc4c2dcb0c3c4a70dcde02c' % (lat, lon)
        page = requests.get(url)
        answer = page.json()
        hourly = answer.get('hourly')
        cols_count = len(hourly)

        for row in range(1, cols_count):
            weather = []
            timestamp = hourly[row].get('dt')
            data = datetime.datetime.fromtimestamp(timestamp).strftime('%Y-%m-%d %H:%M:%S')
            temp = hourly[row].get('temp')
            feels_like = hourly[row].get('feels_like')
            pressure = hourly[row].get('pressure')
            pressure_mm = round((pressure / 133.3224) * 100, 2)
            wind_speed = hourly[row].get('wind_speed')
            wind_deg = hourly[row].get('wind_deg')
            #wind_deg_str = degToCompass(wind_deg)
            rain = hourly[row].get('rain')
            if rain == None:
                osadki = 0.0
            else:
                osadki = rain.get('1h')
            humidity = hourly[row].get('humidity')
            description = hourly[row].get('weather')[0].get('description')
            weather.extend((data, temp, feels_like, pressure, pressure_mm, wind_speed, osadki, humidity, description))
        lat_list.append(lat)
        lon_list.append(lon)
        date_list.append(weather[0])
        temp_list.append(weather[1])
        feels_like_list.append(weather[2])
        pressure_list.append(weather[3])
        pressure_mm_list.append(weather[4])
        wind_speed_list.append(weather[5])
        osadki_list.append(weather[6])
        humidity_list.append(weather[7])
                
    weatherJSON['lat'] = lat_list
    weatherJSON['lon'] = lon_list
    weatherJSON['date'] = date_list
    weatherJSON['temp'] = temp_list
    weatherJSON['feels_like'] = feels_like_list
    weatherJSON['pressure'] = pressure_list
    weatherJSON['pressure_mm'] = pressure_mm_list
    weatherJSON['wind_speed'] = wind_speed_list
    weatherJSON['osadki'] = osadki_list
    weatherJSON['humidity'] = humidity_list
    return weatherJSON

def createSHPFromTXT(path_to_txt, path_to_shp):    
    df = pd.read_csv(path_to_txt)
    gdf = geopandas.GeoDataFrame(
        df, geometry=geopandas.points_from_xy(df[' lon'], df['lat']), crs="EPSG:4326")
    gdf_3395 = gdf.to_crs("EPSG:3395")
    gdf_3395.to_file(path_to_shp)
    return path_to_shp

def createSHPfromDF(weatherJSON, path_to_shp):
    df = pd.DataFrame(weatherJSON)
    gdf = geopandas.GeoDataFrame(
        df, geometry=geopandas.points_from_xy(df['lon'], df['lat']), crs="EPSG:4326")
    gdf_3395 = gdf.to_crs("EPSG:3395")
    gdf_3395.to_file(path_to_shp)
    return path_to_shp

def checkAndCreatePath(path_to_folder):
    if not os.path.exists(path_to_folder):
        os.makedirs(path_to_folder)
    return path_to_folder

path = checkAndCreatePath(os.path.join(out_folder, 'data'))

coord_list = [(36.336077802000034, 55.326165555000046), (36.425909330000025, 55.326165555000046), (36.51574085800007, 55.326165555000046), 
            (36.60557238700005, 55.326165555000046), (36.69540391500004, 55.326165555000046), (36.78523544400008, 55.326165555000046), 
            (36.87506697200007, 55.326165555000046), (36.96489850000006, 55.326165555000046), (37.05473002900004, 55.326165555000046), 
            (37.14456155700003, 55.326165555000046), (37.23439308600007, 55.326165555000046), (37.32422461400006, 55.326165555000046), 
            (37.41405614300004, 55.326165555000046), (37.50388767100003, 55.326165555000046), (37.59371919900008, 55.326165555000046), 
            (37.68355072800006, 55.326165555000046), (37.77338225600005, 55.326165555000046), (37.86321378500003, 55.326165555000046), 
            (37.953045313000075, 55.326165555000046), (38.042876841000066, 55.326165555000046), (38.132708370000046, 55.326165555000046), 
            (38.222539898000036, 55.326165555000046), (38.31237142700007, 55.326165555000046), (38.402202955000064, 55.326165555000046), 
            (38.492034483000054, 55.326165555000046), (38.581866012000035, 55.326165555000046), (38.671697540000025, 55.326165555000046), 
            (36.336077802000034, 55.37723813200006), (36.425909330000025, 55.37723813200006), (36.51574085800007, 55.37723813200006), 
            (36.60557238700005, 55.37723813200006), (36.69540391500004, 55.37723813200006), (36.78523544400008, 55.37723813200006), 
            (36.87506697200007, 55.37723813200006), (36.96489850000006, 55.37723813200006), (37.05473002900004, 55.37723813200006), 
            (37.14456155700003, 55.37723813200006), (37.23439308600007, 55.37723813200006), (37.32422461400006, 55.37723813200006), 
            (37.41405614300004, 55.37723813200006), (37.50388767100003, 55.37723813200006), (37.59371919900008, 55.37723813200006), 
            (37.68355072800006, 55.37723813200006), (37.77338225600005, 55.37723813200006), (37.86321378500003, 55.37723813200006), 
            (37.953045313000075, 55.37723813200006), (38.042876841000066, 55.37723813200006), (38.132708370000046, 55.37723813200006), 
            (38.222539898000036, 55.37723813200006), (38.31237142700007, 55.37723813200006), (38.402202955000064, 55.37723813200006), 
            (38.492034483000054, 55.37723813200006), (38.581866012000035, 55.37723813200006), (38.671697540000025, 55.37723813200006), 
            (36.336077802000034, 55.42824485600005), (36.425909330000025, 55.42824485600005), (36.51574085800007, 55.42824485600005), 
            (36.60557238700005, 55.42824485600005), (36.69540391500004, 55.42824485600005), (36.78523544400008, 55.42824485600005), 
            (36.87506697200007, 55.42824485600005), (36.96489850000006, 55.42824485600005), (37.05473002900004, 55.42824485600005), 
            (37.14456155700003, 55.42824485600005), (37.23439308600007, 55.42824485600005), (37.32422461400006, 55.42824485600005), 
            (37.41405614300004, 55.42824485600005), (37.50388767100003, 55.42824485600005), (37.59371919900008, 55.42824485600005), 
            (37.68355072800006, 55.42824485600005), (37.77338225600005, 55.42824485600005), (37.86321378500003, 55.42824485600005), 
            (37.953045313000075, 55.42824485600005), (38.042876841000066, 55.42824485600005), (38.132708370000046, 55.42824485600005), 
            (38.222539898000036, 55.42824485600005), (38.31237142700007, 55.42824485600005), (38.402202955000064, 55.42824485600005), 
            (38.492034483000054, 55.42824485600005), (38.581866012000035, 55.42824485600005), (38.671697540000025, 55.42824485600005), 
            (36.336077802000034, 55.47918577400003), (36.425909330000025, 55.47918577400003), (36.51574085800007, 55.47918577400003), 
            (36.60557238700005, 55.47918577400003), (36.69540391500004, 55.47918577400003), (36.78523544400008, 55.47918577400003), 
            (36.87506697200007, 55.47918577400003), (36.96489850000006, 55.47918577400003), (37.05473002900004, 55.47918577400003), 
            (37.14456155700003, 55.47918577400003), (37.23439308600007, 55.47918577400003), (37.32422461400006, 55.47918577400003), 
            (37.41405614300004, 55.47918577400003), (37.50388767100003, 55.47918577400003), (37.59371919900008, 55.47918577400003), 
            (37.68355072800006, 55.47918577400003), (37.77338225600005, 55.47918577400003), (37.86321378500003, 55.47918577400003), 
            (37.953045313000075, 55.47918577400003), (38.042876841000066, 55.47918577400003), (38.132708370000046, 55.47918577400003), 
            (38.222539898000036, 55.47918577400003), (38.31237142700007, 55.47918577400003), (38.402202955000064, 55.47918577400003), 
            (38.492034483000054, 55.47918577400003), (38.581866012000035, 55.47918577400003), (38.671697540000025, 55.47918577400003), 
            (36.336077802000034, 55.53006092900006), (36.425909330000025, 55.53006092900006), (36.51574085800007, 55.53006092900006), 
            (36.60557238700005, 55.53006092900006), (36.69540391500004, 55.53006092900006), (36.78523544400008, 55.53006092900006), 
            (36.87506697200007, 55.53006092900006), (36.96489850000006, 55.53006092900006), (37.05473002900004, 55.53006092900006), 
            (37.14456155700003, 55.53006092900006), (37.23439308600007, 55.53006092900006), (37.32422461400006, 55.53006092900006), 
            (37.41405614300004, 55.53006092900006), (37.50388767100003, 55.53006092900006), (37.59371919900008, 55.53006092900006), 
            (37.68355072800006, 55.53006092900006), (37.77338225600005, 55.53006092900006), (37.86321378500003, 55.53006092900006), 
            (37.953045313000075, 55.53006092900006), (38.042876841000066, 55.53006092900006), (38.132708370000046, 55.53006092900006), 
            (38.222539898000036, 55.53006092900006), (38.31237142700007, 55.53006092900006), (38.402202955000064, 55.53006092900006), 
            (38.492034483000054, 55.53006092900006), (38.581866012000035, 55.53006092900006), (38.671697540000025, 55.53006092900006), 
            (36.336077802000034, 55.580870367000045), (36.425909330000025, 55.580870367000045), (36.51574085800007, 55.580870367000045), 
            (36.60557238700005, 55.580870367000045), (36.69540391500004, 55.580870367000045), (36.78523544400008, 55.580870367000045), 
            (36.87506697200007, 55.580870367000045), (36.96489850000006, 55.580870367000045), (37.05473002900004, 55.580870367000045), 
            (37.14456155700003, 55.580870367000045), (37.23439308600007, 55.580870367000045), (37.32422461400006, 55.580870367000045), 
            (37.41405614300004, 55.580870367000045), (37.50388767100003, 55.580870367000045), (37.59371919900008, 55.580870367000045), 
            (37.68355072800006, 55.580870367000045), (37.77338225600005, 55.580870367000045), (37.86321378500003, 55.580870367000045), 
            (37.953045313000075, 55.580870367000045), (38.042876841000066, 55.580870367000045), (38.132708370000046, 55.580870367000045), 
            (38.222539898000036, 55.580870367000045), (38.31237142700007, 55.580870367000045), (38.402202955000064, 55.580870367000045), 
            (38.492034483000054, 55.580870367000045), (38.581866012000035, 55.580870367000045), (38.671697540000025, 55.580870367000045), 
            (36.336077802000034, 55.63161413200004), (36.425909330000025, 55.63161413200004), (36.51574085800007, 55.63161413200004), 
            (36.60557238700005, 55.63161413200004), (36.69540391500004, 55.63161413200004), (36.78523544400008, 55.63161413200004), 
            (36.87506697200007, 55.63161413200004), (36.96489850000006, 55.63161413200004), (37.05473002900004, 55.63161413200004), 
            (37.14456155700003, 55.63161413200004), (37.23439308600007, 55.63161413200004), (37.32422461400006, 55.63161413200004), 
            (37.41405614300004, 55.63161413200004), (37.50388767100003, 55.63161413200004), (37.59371919900008, 55.63161413200004), 
            (37.68355072800006, 55.63161413200004), (37.77338225600005, 55.63161413200004), (37.86321378500003, 55.63161413200004), 
            (37.953045313000075, 55.63161413200004), (38.042876841000066, 55.63161413200004), (38.132708370000046, 55.63161413200004), 
            (38.222539898000036, 55.63161413200004), (38.31237142700007, 55.63161413200004), (38.402202955000064, 55.63161413200004), 
            (38.492034483000054, 55.63161413200004), (38.581866012000035, 55.63161413200004), (38.671697540000025, 55.63161413200004), 
            (36.336077802000034, 55.68229226900007), (36.425909330000025, 55.68229226900007), (36.51574085800007, 55.68229226900007), 
            (36.60557238700005, 55.68229226900007), (36.69540391500004, 55.68229226900007), (36.78523544400008, 55.68229226900007), 
            (36.87506697200007, 55.68229226900007), (36.96489850000006, 55.68229226900007), (37.05473002900004, 55.68229226900007), 
            (37.14456155700003, 55.68229226900007), (37.23439308600007, 55.68229226900007), (37.32422461400006, 55.68229226900007), 
            (37.41405614300004, 55.68229226900007), (37.50388767100003, 55.68229226900007), (37.59371919900008, 55.68229226900007), 
            (37.68355072800006, 55.68229226900007), (37.77338225600005, 55.68229226900007), (37.86321378500003, 55.68229226900007), 
            (37.953045313000075, 55.68229226900007), (38.042876841000066, 55.68229226900007), (38.132708370000046, 55.68229226900007), 
            (38.222539898000036, 55.68229226900007), (38.31237142700007, 55.68229226900007), (38.402202955000064, 55.68229226900007), 
            (38.492034483000054, 55.68229226900007), (38.581866012000035, 55.68229226900007), (38.671697540000025, 55.68229226900007), 
            (36.336077802000034, 55.73290482500005), (36.425909330000025, 55.73290482500005), (36.51574085800007, 55.73290482500005), 
            (36.60557238700005, 55.73290482500005), (36.69540391500004, 55.73290482500005), (36.78523544400008, 55.73290482500005), 
            (36.87506697200007, 55.73290482500005), (36.96489850000006, 55.73290482500005), (37.05473002900004, 55.73290482500005), 
            (37.14456155700003, 55.73290482500005), (37.23439308600007, 55.73290482500005), (37.32422461400006, 55.73290482500005), 
            (37.41405614300004, 55.73290482500005), (37.50388767100003, 55.73290482500005), (37.59371919900008, 55.73290482500005), 
            (37.68355072800006, 55.73290482500005), (37.77338225600005, 55.73290482500005), (37.86321378500003, 55.73290482500005), 
            (37.953045313000075, 55.73290482500005), (38.042876841000066, 55.73290482500005), (38.132708370000046, 55.73290482500005), 
            (38.222539898000036, 55.73290482500005), (38.31237142700007, 55.73290482500005), (38.402202955000064, 55.73290482500005), 
            (38.492034483000054, 55.73290482500005), (38.581866012000035, 55.73290482500005), (38.671697540000025, 55.73290482500005), 
            (36.336077802000034, 55.78345184300008), (36.425909330000025, 55.78345184300008), (36.51574085800007, 55.78345184300008), 
            (36.60557238700005, 55.78345184300008), (36.69540391500004, 55.78345184300008), (36.78523544400008, 55.78345184300008), 
            (36.87506697200007, 55.78345184300008), (36.96489850000006, 55.78345184300008), (37.05473002900004, 55.78345184300008), 
            (37.14456155700003, 55.78345184300008), (37.23439308600007, 55.78345184300008), (37.32422461400006, 55.78345184300008), 
            (37.41405614300004, 55.78345184300008), (37.50388767100003, 55.78345184300008), (37.59371919900008, 55.78345184300008), 
            (37.68355072800006, 55.78345184300008), (37.77338225600005, 55.78345184300008), (37.86321378500003, 55.78345184300008), 
            (37.953045313000075, 55.78345184300008), (38.042876841000066, 55.78345184300008), (38.132708370000046, 55.78345184300008), 
            (38.222539898000036, 55.78345184300008), (38.31237142700007, 55.78345184300008), (38.402202955000064, 55.78345184300008), 
            (38.492034483000054, 55.78345184300008), (38.581866012000035, 55.78345184300008), (38.671697540000025, 55.78345184300008), 
            (36.336077802000034, 55.83393337100006), (36.425909330000025, 55.83393337100006), (36.51574085800007, 55.83393337100006), 
            (36.60557238700005, 55.83393337100006), (36.69540391500004, 55.83393337100006), (36.78523544400008, 55.83393337100006), 
            (36.87506697200007, 55.83393337100006), (36.96489850000006, 55.83393337100006), (37.05473002900004, 55.83393337100006), 
            (37.14456155700003, 55.83393337100006), (37.23439308600007, 55.83393337100006), (37.32422461400006, 55.83393337100006), 
            (37.41405614300004, 55.83393337100006), (37.50388767100003, 55.83393337100006), (37.59371919900008, 55.83393337100006), 
            (37.68355072800006, 55.83393337100006), (37.77338225600005, 55.83393337100006), (37.86321378500003, 55.83393337100006), 
            (37.953045313000075, 55.83393337100006), (38.042876841000066, 55.83393337100006), (38.132708370000046, 55.83393337100006), 
            (38.222539898000036, 55.83393337100006), (38.31237142700007, 55.83393337100006), (38.402202955000064, 55.83393337100006), 
            (38.492034483000054, 55.83393337100006), (38.581866012000035, 55.83393337100006), (38.671697540000025, 55.83393337100006), 
            (36.336077802000034, 55.88434945300003), (36.425909330000025, 55.88434945300003), (36.51574085800007, 55.88434945300003), 
            (36.60557238700005, 55.88434945300003), (36.69540391500004, 55.88434945300003), (36.78523544400008, 55.88434945300003), 
            (36.87506697200007, 55.88434945300003), (36.96489850000006, 55.88434945300003), (37.05473002900004, 55.88434945300003), 
            (37.14456155700003, 55.88434945300003), (37.23439308600007, 55.88434945300003), (37.32422461400006, 55.88434945300003), 
            (37.41405614300004, 55.88434945300003), (37.50388767100003, 55.88434945300003), (37.59371919900008, 55.88434945300003), 
            (37.68355072800006, 55.88434945300003), (37.77338225600005, 55.88434945300003), (37.86321378500003, 55.88434945300003), 
            (37.953045313000075, 55.88434945300003), (38.042876841000066, 55.88434945300003), (38.132708370000046, 55.88434945300003), 
            (38.222539898000036, 55.88434945300003), (38.31237142700007, 55.88434945300003), (38.402202955000064, 55.88434945300003), 
            (38.492034483000054, 55.88434945300003), (38.581866012000035, 55.88434945300003), (38.671697540000025, 55.88434945300003), 
            (36.336077802000034, 55.93470013600006), (36.425909330000025, 55.93470013600006), (36.51574085800007, 55.93470013600006), 
            (36.60557238700005, 55.93470013600006), (36.69540391500004, 55.93470013600006), (36.78523544400008, 55.93470013600006), 
            (36.87506697200007, 55.93470013600006), (36.96489850000006, 55.93470013600006), (37.05473002900004, 55.93470013600006), 
            (37.14456155700003, 55.93470013600006), (37.23439308600007, 55.93470013600006), (37.32422461400006, 55.93470013600006), 
            (37.41405614300004, 55.93470013600006), (37.50388767100003, 55.93470013600006), (37.59371919900008, 55.93470013600006), 
            (37.68355072800006, 55.93470013600006), (37.77338225600005, 55.93470013600006), (37.86321378500003, 55.93470013600006), 
            (37.953045313000075, 55.93470013600006), (38.042876841000066, 55.93470013600006), (38.132708370000046, 55.93470013600006), 
            (38.222539898000036, 55.93470013600006), (38.31237142700007, 55.93470013600006), (38.402202955000064, 55.93470013600006), 
            (38.492034483000054, 55.93470013600006), (38.581866012000035, 55.93470013600006), (38.671697540000025, 55.93470013600006), 
            (36.336077802000034, 55.98498546500008), (36.425909330000025, 55.98498546500008), (36.51574085800007, 55.98498546500008), 
            (36.60557238700005, 55.98498546500008), (36.69540391500004, 55.98498546500008), (36.78523544400008, 55.98498546500008), 
            (36.87506697200007, 55.98498546500008), (36.96489850000006, 55.98498546500008), (37.05473002900004, 55.98498546500008), 
            (37.14456155700003, 55.98498546500008), (37.23439308600007, 55.98498546500008), (37.32422461400006, 55.98498546500008), 
            (37.41405614300004, 55.98498546500008), (37.50388767100003, 55.98498546500008), (37.59371919900008, 55.98498546500008), 
            (37.68355072800006, 55.98498546500008), (37.77338225600005, 55.98498546500008), (37.86321378500003, 55.98498546500008), 
            (37.953045313000075, 55.98498546500008), (38.042876841000066, 55.98498546500008), (38.132708370000046, 55.98498546500008), 
            (38.222539898000036, 55.98498546500008), (38.31237142700007, 55.98498546500008), (38.402202955000064, 55.98498546500008), 
            (38.492034483000054, 55.98498546500008), (38.581866012000035, 55.98498546500008), (38.671697540000025, 55.98498546500008), 
            (36.336077802000034, 56.03520548600005), (36.425909330000025, 56.03520548600005), (36.51574085800007, 56.03520548600005)]
print(datetime.datetime.now())
weatherJSON = downloadWeatherData(coord_list)
print(datetime.datetime.now())
poi_shp = createSHPfromDF(weatherJSON, os.path.join(path, 'poi_shp'))

ulx = 4044554.4439070006
uly = 7569517.354207003 
res = 718.468786000013
xsize = 362 
ysize = 250
lrx = 4304640.144439005
lry = 7389900.157706999

out_dem_name = "temperature.tif"

nn = gdal.Grid(os.path.join(path, out_dem_name), poi_shp, outputType = gdal.GDT_Float32, format='GTiff', zfield="temp",
               algorithm = "invdist:power=3",
               width = xsize, height = ysize)
nn = None
temp_dem = gdal.Open(os.path.join(path, out_dem_name))
temp_dem_band1 = temp_dem.GetRasterBand(1)
wkt = temp_dem.GetProjection()
proj = osr.SpatialReference(wkt)

contourPath = os.path.join(path, 'contour.shp')
contourDs = ogr.GetDriverByName("ESRI Shapefile").CreateDataSource(contourPath)
contourShp = contourDs.CreateLayer('contour', proj)

fieldDef = ogr.FieldDefn("ID", ogr.OFTInteger)
contourShp.CreateField(fieldDef)
fieldDef = ogr.FieldDefn("value", ogr.OFTReal)
contourShp.CreateField(fieldDef)

gdal.ContourGenerate(temp_dem_band1, 0.5, 11, [], 0, 0, contourShp, 0, 1)
contourDs.Destroy()

# create polygon from line feature by buffer
d = gpd.read_file(contourPath)
x = d.buffer(0.0001)

# simplified
tolerance = 0.6
simplified = x.simplify(tolerance, preserve_topology=True)
simplified.to_file(os.path.join(path, 'contour_simplified.shp'))

# create temperature polygon
df1 = gpd.read_file(r"W:\Big_Project\__MAPS\!Current\_06_June_21\VB\atmo\openweather_temp\bbox_pol\bbox_pol.shp")
df2 = gpd.read_file(os.path.join(path, 'contour_simplified.shp'))
res_difference = geopandas.overlay(df1, df2, how='difference')
res_difference.to_file(os.path.join(path, 'contour_simplified_multipolygon.shp'))

# multipolygon to single
gpdf = gp.read_file(os.path.join(path, 'contour_simplified_multipolygon.shp'))
single = multi2single(gpdf)
single.to_file(os.path.join(path, 'contour_simplified_single_polygon.shp'))
